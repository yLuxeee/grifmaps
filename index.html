<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grifmaps</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        --app-bg: radial-gradient(circle at top left, #edf2f7, #c3dafe);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.9));
        --toolbar-text: #0f172a;
        --panel-bg: rgba(255, 255, 255, 0.9);
        --panel-border: rgba(148, 163, 184, 0.35);
        --hint-bg: rgba(226, 232, 240, 0.6);
        --field-border: rgba(15, 23, 42, 0.85);
        --field-bg: #d4d4d8;
        --goal-outline: rgba(15, 23, 42, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--app-bg);
        padding: clamp(16px, 3vw, 32px);
        color: var(--toolbar-text);
      }

      body[data-theme="dark"] {
        --app-bg: radial-gradient(circle at top left, #0f172a, #1e293b);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
        --toolbar-text: #e2e8f0;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(148, 163, 184, 0.2);
        --hint-bg: rgba(30, 41, 59, 0.75);
        --field-border: rgba(226, 232, 240, 0.65);
        --field-bg: #1f2937;
        --goal-outline: rgba(148, 163, 184, 0.6);
      }

      body[data-theme="bubblegum"] {
        --app-bg: radial-gradient(circle at top left, #fde2f3, #fbcfe8);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 236, 248, 0.96), rgba(250, 225, 240, 0.9));
        --toolbar-text: #831843;
        --panel-bg: rgba(255, 236, 248, 0.92);
        --panel-border: rgba(244, 114, 182, 0.35);
        --hint-bg: rgba(253, 230, 246, 0.7);
        --field-border: rgba(157, 23, 77, 0.7);
        --field-bg: #fdf2f8;
        --goal-outline: rgba(131, 24, 67, 0.4);
      }

      body[data-theme="rgb"] {
        --app-bg: radial-gradient(circle at top left, #0ea5e9, #7c3aed 45%, #f43f5e);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 41, 59, 0.7));
        --toolbar-text: #f8fafc;
        --panel-bg: rgba(15, 23, 42, 0.85);
        --panel-border: rgba(248, 250, 252, 0.2);
        --hint-bg: rgba(15, 23, 42, 0.65);
        --field-border: rgba(248, 250, 252, 0.6);
        --field-bg: #0f172a;
        --goal-outline: rgba(248, 250, 252, 0.5);
      }

      body[data-theme="creamsicle"] {
        --app-bg: radial-gradient(circle at top left, #ffedd5, #fed7aa);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 247, 237, 0.96), rgba(254, 215, 170, 0.9));
        --toolbar-text: #7c2d12;
        --panel-bg: rgba(255, 247, 237, 0.92);
        --panel-border: rgba(251, 146, 60, 0.35);
        --hint-bg: rgba(255, 237, 213, 0.7);
        --field-border: rgba(124, 45, 18, 0.6);
        --field-bg: #fff7ed;
      }
        
        body[data-theme="menthol"] {
        --app-bg: radial-gradient(circle at top left, #dcfce7, #86efac);
        --toolbar-bg: linear-gradient(135deg, rgba(220, 252, 231, 0.98), rgba(134, 239, 172, 0.92));
        --toolbar-text: #14532d;
        --panel-bg: rgba(220, 252, 231, 0.92);
        --panel-border: rgba(34, 197, 94, 0.35);
        --hint-bg: rgba(187, 247, 208, 0.75);
        --field-border: rgba(20, 83, 45, 0.55);
        --field-bg: #ecfdf5;
        --goal-outline: rgba(20, 83, 45, 0.35);
      }

      body[data-theme="red-samurai"] {
        --app-bg: radial-gradient(circle at top left, #0f172a, #7f1d1d 50%, #dc2626);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(127, 29, 29, 0.85));
        --toolbar-text: #fee2e2;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(248, 113, 113, 0.35);
        --hint-bg: rgba(15, 23, 42, 0.7);
        --field-border: rgba(248, 113, 113, 0.6);
        --field-bg: #111827;
        --goal-outline: rgba(248, 113, 113, 0.5);
      }

      body[data-theme="grape"] {
        --app-bg: radial-gradient(circle at top left, #ede9fe, #c4b5fd 55%, #8b5cf6);
        --toolbar-bg: linear-gradient(135deg, rgba(237, 233, 254, 0.96), rgba(196, 181, 253, 0.9));
        --toolbar-text: #4c1d95;
        --panel-bg: rgba(237, 233, 254, 0.92);
        --panel-border: rgba(139, 92, 246, 0.35);
        --hint-bg: rgba(221, 214, 254, 0.75);
        --field-border: rgba(76, 29, 149, 0.55);
        --field-bg: #f5f3ff;
        --goal-outline: rgba(76, 29, 149, 0.35);
      }

      body[data-theme="night-runner"] {
        --app-bg: radial-gradient(circle at top left, #020617, #0ea5e9 45%, #1e1b4b);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(2, 132, 199, 0.7));
        --toolbar-text: #e0f2fe;
        --panel-bg: rgba(2, 6, 23, 0.9);
        --panel-border: rgba(56, 189, 248, 0.35);
        --hint-bg: rgba(2, 6, 23, 0.7);
        --field-border: rgba(56, 189, 248, 0.6);
        --field-bg: #0b1120;
        --goal-outline: rgba(56, 189, 248, 0.45);
      }

      body[data-theme="phantom"] {
        --app-bg: radial-gradient(circle at top left, #0f172a, #334155 55%, #0f766e);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(15, 118, 110, 0.65));
        --toolbar-text: #e2e8f0;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(45, 212, 191, 0.35);
        --hint-bg: rgba(15, 23, 42, 0.7);
        --field-border: rgba(45, 212, 191, 0.5);
        --field-bg: #0f172a;
        --goal-outline: rgba(45, 212, 191, 0.45);
      }

      body[data-theme="shadow"] {
        --app-bg: radial-gradient(circle at top left, #111827, #1f2937 55%, #000000);
        --toolbar-bg: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(0, 0, 0, 0.85));
        --toolbar-text: #e5e7eb;
        --panel-bg: rgba(17, 24, 39, 0.92);
        --panel-border: rgba(148, 163, 184, 0.25);
        --hint-bg: rgba(17, 24, 39, 0.75);
        --field-border: rgba(148, 163, 184, 0.45);
        --field-bg: #111827;
        --goal-outline: rgba(148, 163, 184, 0.35);
      }

      body[data-theme="nexus"] {
        --app-bg: radial-gradient(circle at top left, #f472b6, #22d3ee 50%, #0ea5e9);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(34, 211, 238, 0.65));
        --toolbar-text: #f8fafc;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(244, 114, 182, 0.4);
        --hint-bg: rgba(15, 23, 42, 0.7);
        --field-border: rgba(244, 114, 182, 0.6);
        --field-bg: #0f172a;
        --goal-outline: rgba(34, 211, 238, 0.5);
      }

      body[data-theme="drowning"] {
        --app-bg: radial-gradient(circle at top left, #0f172a, #0f3d5c 45%, #1e40af);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 64, 175, 0.72));
        --toolbar-text: #e0f2fe;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(56, 189, 248, 0.35);
        --hint-bg: rgba(15, 23, 42, 0.7);
        --field-border: rgba(56, 189, 248, 0.55);
        --field-bg: #0b1e34;
        --goal-outline: rgba(56, 189, 248, 0.45);
      }

      body[data-theme="spiderman"] {
        --app-bg: radial-gradient(circle at top left, #2f4d7c, #7f1d1d 55%, #0f172a);
        --toolbar-bg: linear-gradient(135deg, rgba(127, 29, 29, 0.9), rgba(15, 23, 42, 0.85));
        --toolbar-text: #55ddff;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(248, 113, 113, 0.35);
        --hint-bg: rgba(15, 23, 42, 0.7);
        --field-border: rgba(52, 104, 247, 0.55);
        --field-bg: #0d1e41;
        --goal-outline: rgba(248, 113, 113, 0.5);
      }

      body[data-theme="honey"] {
        --app-bg: radial-gradient(circle at top left, #fef3c7, #f59e0b 60%, #fbbf24);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 247, 237, 0.96), rgba(253, 230, 138, 0.92));
        --toolbar-text: #92400e;
        --panel-bg: rgba(255, 251, 235, 0.92);
        --panel-border: rgba(251, 146, 60, 0.35);
        --hint-bg: rgba(254, 243, 199, 0.7);
        --field-border: rgba(146, 64, 14, 0.55);
        --field-bg: #fff7ed;
        --goal-outline: rgba(146, 64, 14, 0.35);
      }

      body[data-theme="mexican"] {
        --app-bg: radial-gradient(circle at top left, #f97316, #22c55e 50%, #facc15);
        --toolbar-bg: linear-gradient(135deg, rgba(254, 215, 170, 0.95), rgba(134, 239, 172, 0.88));
        --toolbar-text: #7c2d12;
        --panel-bg: rgba(255, 237, 213, 0.92);
        --panel-border: rgba(34, 197, 94, 0.35);
        --hint-bg: rgba(254, 215, 170, 0.7);
        --field-border: rgba(124, 45, 18, 0.6);
        --field-bg: #fff7ed;
        --goal-outline: rgba(21, 128, 61, 0.4);
      }

      body[data-theme="retrocast"] {
        --app-bg: radial-gradient(circle at top left, #0ea5e9, #facc15 60%, #38bdf8);
        --toolbar-bg: linear-gradient(135deg, rgba(14, 116, 144, 0.9), rgba(250, 204, 21, 0.7));
        --toolbar-text: #0f172a;
        --panel-bg: rgba(255, 255, 255, 0.9);
        --panel-border: rgba(14, 116, 144, 0.4);
        --hint-bg: rgba(250, 204, 21, 0.25);
        --field-border: rgba(14, 116, 144, 0.6);
        --field-bg: #e0f2fe;
        --goal-outline: rgba(14, 116, 144, 0.35);
      }

      body[data-theme="cheesecake"] {
        --app-bg: radial-gradient(circle at top left, #fff7ed, #fbcfe8 50%, #fde68a);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 247, 237, 0.96), rgba(252, 231, 243, 0.9));
        --toolbar-text: #9d174d;
        --panel-bg: rgba(255, 247, 237, 0.92);
        --panel-border: rgba(244, 114, 182, 0.35);
        --hint-bg: rgba(253, 230, 138, 0.4);
        --field-border: rgba(157, 23, 77, 0.55);
        --field-bg: #fff1f2;
        --goal-outline: rgba(157, 23, 77, 0.35);
      }

      body[data-theme="rainbow-trail"] {
        --app-bg: linear-gradient(135deg, #f43f5e, #f97316 20%, #facc15 40%, #22c55e 60%, #38bdf8 80%, #8b5cf6);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.6));
        --toolbar-text: #f8fafc;
        --panel-bg: rgba(15, 23, 42, 0.85);
        --panel-border: rgba(248, 250, 252, 0.25);
        --hint-bg: rgba(15, 23, 42, 0.65);
        --field-border: rgba(248, 250, 252, 0.5);
        --field-bg: #0f172a;
        --goal-outline: rgba(248, 250, 252, 0.45);
      }

      body[data-theme="iceberg"] {
        --app-bg: radial-gradient(circle at top left, #e0f2fe, #bae6fd 55%, #93c5fd);
        --toolbar-bg: linear-gradient(135deg, rgba(224, 242, 254, 0.96), rgba(186, 230, 253, 0.9));
        --toolbar-text: #1e3a8a;
        --panel-bg: rgba(224, 242, 254, 0.92);
        --panel-border: rgba(59, 130, 246, 0.35);
        --hint-bg: rgba(224, 242, 254, 0.75);
        --field-border: rgba(30, 64, 175, 0.45);
        --field-bg: #eff6ff;
        --goal-outline: rgba(30, 64, 175, 0.35);
      }

      body[data-theme="godspeed"] {
        --app-bg: radial-gradient(circle at top left, #111827, #111827 45%, #f97316);
        --toolbar-bg: linear-gradient(135deg, rgba(17, 24, 39, 0.94), rgba(249, 115, 22, 0.7));
        --toolbar-text: #fef3c7;
        --panel-bg: rgba(17, 24, 39, 0.9);
        --panel-border: rgba(249, 115, 22, 0.35);
        --hint-bg: rgba(17, 24, 39, 0.75);
        --field-border: rgba(249, 115, 22, 0.55);
        --field-bg: #111827;
        --goal-outline: rgba(249, 115, 22, 0.45);
      }

      body[data-theme="lavender"] {
        --app-bg: radial-gradient(circle at top left, #f5f3ff, #ddd6fe 55%, #c4b5fd);
        --toolbar-bg: linear-gradient(135deg, rgba(245, 243, 255, 0.96), rgba(221, 214, 254, 0.9));
        --toolbar-text: #4c1d95;
        --panel-bg: rgba(245, 243, 255, 0.92);
        --panel-border: rgba(139, 92, 246, 0.35);
        --hint-bg: rgba(221, 214, 254, 0.75);
        --field-border: rgba(76, 29, 149, 0.45);
        --field-bg: #f5f3ff;
        --goal-outline: rgba(76, 29, 149, 0.35);
      }

      body[data-theme="pink-lemonade"] {
        --app-bg: radial-gradient(circle at top left, #fff1f2, #fbcfe8 45%, #fde68a);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 241, 242, 0.96), rgba(254, 215, 170, 0.9));
        --toolbar-text: #9f1239;
        --panel-bg: rgba(255, 241, 242, 0.92);
        --panel-border: rgba(251, 113, 133, 0.35);
        --hint-bg: rgba(254, 215, 170, 0.6);
        --field-border: rgba(159, 18, 57, 0.45);
        --field-bg: #fff7ed;
        --goal-outline: rgba(159, 18, 57, 0.35);
      }

      body[data-theme="glitch"] {
        --app-bg: radial-gradient(circle at top left, #0f172a, #312e81 50%, #831843);
        --toolbar-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(131, 24, 67, 0.7));
        --toolbar-text: #fdf2f8;
        --panel-bg: rgba(15, 23, 42, 0.9);
        --panel-border: rgba(244, 114, 182, 0.35);
        --hint-bg: rgba(15, 23, 42, 0.7);
        --field-border: rgba(129, 140, 248, 0.55);
        --field-bg: #111827;
        --goal-outline: rgba(244, 114, 182, 0.45);
      }

      body[data-theme="antimatter"] {
        --app-bg: radial-gradient(circle at top left, #020617, #0f172a 45%, #4c1d95);
        --toolbar-bg: linear-gradient(135deg, rgba(2, 6, 23, 0.94), rgba(76, 29, 149, 0.7));
        --toolbar-text: #e0e7ff;
        --panel-bg: rgba(2, 6, 23, 0.9);
        --panel-border: rgba(167, 139, 250, 0.3);
        --hint-bg: rgba(2, 6, 23, 0.7);
        --field-border: rgba(167, 139, 250, 0.55);
        --field-bg: #0b1120;
        --goal-outline: rgba(167, 139, 250, 0.45);
      }

      body[data-theme="war"] {
        --app-bg: radial-gradient(circle at top left, #111827, #7f1d1d 75%, #991b1b);
        --toolbar-bg: linear-gradient(135deg, rgba(39, 20, 17, 0.95), rgba(127, 29, 29, 0.78));
        --toolbar-text: #fee2e2;
        --panel-bg: rgba(53, 27, 68, 0.966);
        --panel-border: rgba(255, 0, 0, 0.74);
        --hint-bg: rgba(17, 24, 39, 0.7);
        --field-border: rgba(255, 0, 0, 0.795);
        --field-bg: #111827;
        --goal-outline: rgba(255, 68, 230, 0.705);
      }

      body[data-theme="fruit-chew"] {
        --app-bg: radial-gradient(circle at top left, #f5f3ff, #e2e8f0 55%, #fbcfe8);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(237, 233, 254, 0.9));
        --toolbar-text: #4c1d95;
        --panel-bg: rgba(255, 255, 255, 0.92);
        --panel-border: rgba(139, 92, 246, 0.25);
        --hint-bg: rgba(237, 233, 254, 0.7);
        --field-border: rgba(76, 29, 149, 0.45);
        --field-bg: #f8fafc;
        --goal-outline: rgba(76, 29, 149, 0.35);
      }

      body[data-theme="peaches"] {
        --app-bg: radial-gradient(circle at top left, #fff7ed, #fed7aa 55%, #fdba74);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 247, 237, 0.96), rgba(254, 215, 170, 0.9));
        --toolbar-text: #9a3412;
        --panel-bg: rgba(255, 247, 237, 0.92);
        --panel-border: rgba(251, 146, 60, 0.35);
        --hint-bg: rgba(254, 215, 170, 0.7);
        --field-border: rgba(154, 52, 18, 0.45);
        --field-bg: #fff7ed;
        --goal-outline: rgba(154, 52, 18, 0.35);
      }

      body[data-theme="hanok"] {
        --app-bg: radial-gradient(circle at top left, #fdf6e3, #e7e5e4 55%, #cbd5e1);
        --toolbar-bg: linear-gradient(135deg, rgba(253, 246, 227, 0.96), rgba(231, 229, 228, 0.9));
        --toolbar-text: #3f2f24;
        --panel-bg: rgba(253, 246, 227, 0.92);
        --panel-border: rgba(120, 113, 108, 0.3);
        --hint-bg: rgba(231, 229, 228, 0.7);
        --field-border: rgba(87, 83, 78, 0.45);
        --field-bg: #f5f5f4;
        --goal-outline: rgba(87, 83, 78, 0.35);
      }

      body[data-theme="retro"] {
        --app-bg: radial-gradient(circle at top left, #fef9c3, #fde68a 55%, #facc15);
        --toolbar-bg: linear-gradient(135deg, rgba(254, 249, 195, 0.96), rgba(252, 211, 77, 0.9));
        --toolbar-text: #92400e;
        --panel-bg: rgba(254, 249, 195, 0.92);
        --panel-border: rgba(234, 179, 8, 0.35);
        --hint-bg: rgba(253, 230, 138, 0.7);
        --field-border: rgba(146, 64, 14, 0.45);
        --field-bg: #fffbeb;
        --goal-outline: rgba(146, 64, 14, 0.35);
      }

      body[data-theme="pastel"] {
        --app-bg: radial-gradient(circle at top left, #fdf2f8, #e0f2fe 55%, #ede9fe);
        --toolbar-bg: linear-gradient(135deg, rgba(253, 242, 248, 0.96), rgba(224, 242, 254, 0.9));
        --toolbar-text: #6b21a8;
        --panel-bg: rgba(253, 242, 248, 0.92);
        --panel-border: rgba(192, 132, 252, 0.3);
        --hint-bg: rgba(224, 242, 254, 0.7);
        --field-border: rgba(107, 33, 168, 0.45);
        --field-bg: #fdf4ff;
        --goal-outline: rgba(107, 33, 168, 0.35);
      }

      body[data-theme="vaporwave"] {
        --app-bg: radial-gradient(circle at top left, #a5b4fc, #f0abfc 55%, #38bdf8);
        --toolbar-bg: linear-gradient(135deg, rgba(165, 180, 252, 0.9), rgba(240, 171, 252, 0.85));
        --toolbar-text: #312e81;
        --panel-bg: rgba(240, 171, 252, 0.3);
        --panel-border: rgba(99, 102, 241, 0.4);
        --hint-bg: rgba(191, 219, 254, 0.5);
        --field-border: rgba(99, 102, 241, 0.55);
        --field-bg: #eef2ff;
        --goal-outline: rgba(99, 102, 241, 0.4);
      }

      body[data-theme="frozen-llama"] {
        --app-bg: radial-gradient(circle at top left, #ccfbf1, #a7f3d0 55%, #60a5fa);
        --toolbar-bg: linear-gradient(135deg, rgba(204, 251, 241, 0.96), rgba(167, 243, 208, 0.9));
        --toolbar-text: #0f766e;
        --panel-bg: rgba(204, 251, 241, 0.92);
        --panel-border: rgba(13, 148, 136, 0.35);
        --hint-bg: rgba(167, 243, 208, 0.7);
        --field-border: rgba(13, 148, 136, 0.45);
        --field-bg: #ecfeff;
        --goal-outline: rgba(13, 148, 136, 0.35);
      }

      body[data-theme="mizu"] {
        --app-bg: radial-gradient(circle at top left, #e0f2fe, #bae6fd 55%, #94a3b8);
        --toolbar-bg: linear-gradient(135deg, rgba(224, 242, 254, 0.96), rgba(186, 230, 253, 0.9));
        --toolbar-text: #1e3a8a;
        --panel-bg: rgba(224, 242, 254, 0.92);
        --panel-border: rgba(37, 99, 235, 0.35);
        --hint-bg: rgba(186, 230, 253, 0.7);
        --field-border: rgba(30, 64, 175, 0.45);
        --field-bg: #eff6ff;
        --goal-outline: rgba(30, 64, 175, 0.35);
      }

      body[data-theme="tiramisu"] {
        --app-bg: radial-gradient(circle at top left, #fef3c7, #e7e5e4 55%, #cbd5e1);
        --toolbar-bg: linear-gradient(135deg, rgba(254, 243, 199, 0.96), rgba(231, 229, 228, 0.9));
        --toolbar-text: #78350f;
        --panel-bg: rgba(254, 243, 199, 0.92);
        --panel-border: rgba(202, 138, 4, 0.35);
        --hint-bg: rgba(231, 229, 228, 0.7);
        --field-border: rgba(120, 53, 15, 0.45);
        --field-bg: #fffbeb;
        --goal-outline: rgba(120, 53, 15, 0.35);
      }

      body[data-theme="macroblank"] {
        --app-bg: radial-gradient(circle at top left, #e2e8f0, #cbd5f5 55%, #f5f3ff);
        --toolbar-bg: linear-gradient(135deg, rgba(226, 232, 240, 0.96), rgba(199, 210, 254, 0.9));
        --toolbar-text: #1e293b;
        --panel-bg: rgba(226, 232, 240, 0.92);
        --panel-border: rgba(100, 116, 139, 0.3);
        --hint-bg: rgba(199, 210, 254, 0.6);
        --field-border: rgba(30, 41, 59, 0.45);
        --field-bg: #f1f5f9;
        --goal-outline: rgba(30, 41, 59, 0.35);
      }

      body[data-theme="snes"] {
        --app-bg: radial-gradient(circle at top left, #e5e7eb, #c4b5fd 55%, #a7f3d0);
        --toolbar-bg: linear-gradient(135deg, rgba(229, 231, 235, 0.96), rgba(196, 181, 253, 0.9));
        --toolbar-text: #312e81;
        --panel-bg: rgba(229, 231, 235, 0.92);
        --panel-border: rgba(99, 102, 241, 0.3);
        --hint-bg: rgba(196, 181, 253, 0.6);
        --field-border: rgba(49, 46, 129, 0.45);
        --field-bg: #f3f4f6;
        --goal-outline: rgba(49, 46, 129, 0.35);
      }

      body[data-theme="strawberry"] {
        --app-bg: radial-gradient(circle at top left, #ffe4e6, #fda4af 55%, #f472b6);
        --toolbar-bg: linear-gradient(135deg, rgba(255, 228, 230, 0.96), rgba(253, 164, 175, 0.9));
        --toolbar-text: #9f1239;
        --panel-bg: rgba(255, 228, 230, 0.92);
        --panel-border: rgba(244, 63, 94, 0.35);
        --hint-bg: rgba(253, 164, 175, 0.6);
        --field-border: rgba(159, 18, 57, 0.45);
        --field-bg: #fff1f2;
        --goal-outline: rgba(159, 18, 57, 0.35);
      }

      body[data-theme="bingsu"] {
        --app-bg: radial-gradient(circle at top left, #f1f5f9, #e2e8f0 55%, #cbd5e1);
        --toolbar-bg: linear-gradient(135deg, rgba(241, 245, 249, 0.96), rgba(226, 232, 240, 0.9));
        --toolbar-text: #334155;
        --panel-bg: rgba(241, 245, 249, 0.92);
        --panel-border: rgba(100, 116, 139, 0.25);
        --hint-bg: rgba(226, 232, 240, 0.7);
        --field-border: rgba(51, 65, 85, 0.4);
        --field-bg: #f8fafc;
        --goal-outline: rgba(51, 65, 85, 0.3);
      }

      body[data-theme="cafe"] {
        --app-bg: radial-gradient(circle at top left, #f3e8d3, #d6c1a1 55%, #a78b6d);
        --toolbar-bg: linear-gradient(135deg, rgba(243, 232, 211, 0.96), rgba(214, 193, 161, 0.9));
        --toolbar-text: #4b2e1a;
        --panel-bg: rgba(243, 232, 211, 0.92);
        --panel-border: rgba(146, 98, 61, 0.35);
        --hint-bg: rgba(214, 193, 161, 0.7);
        --field-border: rgba(75, 46, 26, 0.45);
        --field-bg: #fef6e7;
        --goal-outline: rgba(75, 46, 26, 0.35);
      }

      body[data-theme="fleuriste"] {
        --app-bg: radial-gradient(circle at top left, #fce7f3, #fbcfe8 55%, #d6bcfa);
        --toolbar-bg: linear-gradient(135deg, rgba(252, 231, 243, 0.96), rgba(251, 207, 232, 0.9));
        --toolbar-text: #9d174d;
        --panel-bg: rgba(252, 231, 243, 0.92);
        --panel-border: rgba(217, 70, 239, 0.25);
        --hint-bg: rgba(251, 207, 232, 0.7);
        --field-border: rgba(157, 23, 77, 0.45);
        --field-bg: #fdf2f8;
        --goal-outline: rgba(157, 23, 77, 0.35);
      }

      body[data-theme="iv-clover"] {
        --app-bg: radial-gradient(circle at top left, #e2e8f0, #94a3b8 55%, #64748b);
        --toolbar-bg: linear-gradient(135deg, rgba(226, 232, 240, 0.96), rgba(148, 163, 184, 0.9));
        --toolbar-text: #1e293b;
        --panel-bg: rgba(226, 232, 240, 0.92);
        --panel-border: rgba(71, 85, 105, 0.3);
        --hint-bg: rgba(148, 163, 184, 0.6);
        --field-border: rgba(30, 41, 59, 0.45);
        --field-bg: #e2e8f0;
        --goal-outline: rgba(30, 41, 59, 0.35);
      }

      body[data-theme="earthsong"] {
        --app-bg: radial-gradient(circle at top left, #, #2F6133 40%, #0EB259);
        --toolbar-bg: linear-gradient(135deg, rgba(25, 120, 60, 0.96), rgba(2, 90, 36, 0.9));
        --toolbar-text: #69D192;
        --panel-bg: rgba(41, 105, 66, 0.92);
        --panel-border: rgba(5, 31, 10, 0.25);
        --hint-bg: rgba(5, 31, 10, 0.7);
        --field-border: rgba(41, 97, 31, 0.45);
        --field-bg: #1F2E1E;
        --goal-outline: rgba(34, 125, 20, 0.35);
      }

      body[data-theme="trance"] {
        --app-bg: radial-gradient(circle at top left, #60a5fa, #a855f7 50%, #22d3ee);
        --toolbar-bg: linear-gradient(135deg, rgba(96, 165, 250, 0.85), rgba(168, 85, 247, 0.75));
        --toolbar-text: #0f172a;
        --panel-bg: rgba(255, 255, 255, 0.85);
        --panel-border: rgba(59, 130, 246, 0.35);
        --hint-bg: rgba(191, 219, 254, 0.6);
        --field-border: rgba(59, 130, 246, 0.6);
        --field-bg: #eef2ff;
        --goal-outline: rgba(59, 130, 246, 0.45);
        
        background-size: 200% 200%;
      }

      body[data-theme="trance"]::before {
        content: "";
        position: fixed;
        inset: -20%;
        background:
          radial-gradient(circle at 20% 20%, rgba(94, 234, 212, 0.5), transparent 55%),
          radial-gradient(circle at 80% 30%, rgba(217, 70, 239, 0.45), transparent 60%),
          radial-gradient(circle at 30% 80%, rgba(59, 130, 246, 0.45), transparent 55%),
          radial-gradient(circle at 70% 70%, rgba(250, 204, 21, 0.35), transparent 55%);
        filter: blur(20px);
        opacity: 0.85;
        animation: trance-lava 18s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes trance-shift {
        0% {
          --app-bg: radial-gradient(circle at top left, #60a5fa, #a855f7 50%, #22d3ee);
        }
        50% {
          --app-bg: radial-gradient(circle at top left, #22d3ee, #f472b6 50%, #a3e635);
        }
        100% {
          --app-bg: radial-gradient(circle at top left, #60a5fa, #a855f7 50%, #22d3ee);
        }
      }

      

       body.is-loading {
        overflow: hidden;
      }

      .app {
        width: min(98vw, 1280px);
        display: grid;
        gap: 16px;
        opacity: 0;
        animation: app-fade-in 0.6s ease 1.8s forwards;
      }

       footer {
        position: fixed;
        bottom: 18px;
        right: 18px;
        left: auto;
        transform: none;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--toolbar-text);
        opacity: 0.85;
        padding: 4px 0;
        z-index: 20;
        pointer-events: none;
      }

      footer span {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        padding: 6px 14px;
        border-radius: 999px;
        box-shadow: 0 12px 20px rgba(15, 23, 42, 0.18);
        pointer-events: auto;
      }

    

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 14px;
        padding: 14px 18px;
        border-radius: 20px;
        background: var(--toolbar-bg);
        box-shadow: 0 24px 50px rgba(15, 23, 42, 0.18);
        border: 1px solid var(--panel-border);
        backdrop-filter: blur(10px);
      }

      .toolbar h1 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--toolbar-text);
        margin: 0 12px 0 0;
      }

      .toolbar button,
      .toolbar label,
      .toolbar select {
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .toolbar button {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(226, 232, 240, 0.7);
        color: var(--toolbar-text);
        cursor: pointer;
        transition: background 0.2s ease;
        font-weight: 600;
      }

      .toolbar button[data-mode].active {
        background: linear-gradient(120deg, #2563eb, #1d4ed8);
        color: #f8fafc;
        border-color: transparent;
        box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
      }

      .toolbar button:hover {
        background: rgba(203, 213, 245, 0.9);
      }

      .toolbar input[type="color"] {
        width: 44px;
        height: 30px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 0;
        background: none;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      }

      .toolbar input[type="range"] {
        accent-color: #2563eb;
      }

      .toolbar select {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(203, 213, 225, 0.7);
        background: rgba(248, 250, 252, 0.9);
        color: var(--toolbar-text);
        font-weight: 600;
        cursor: pointer;
      }

      

      .toolbar button.icon-button {
        padding: 6px 10px;
        min-width: 0;
        font-size: 0.95rem;
      }

      .toolbar option {
        color: #0f172a;
      }

      

      #quizModeToggle {
        display: none;
      }

      [hidden] {
        display: none !important;
      }

      .challenge-panel {
        background: var(--panel-bg);
        border-radius: 18px;
        padding: 12px;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.2);
        backdrop-filter: blur(6px);
        display: grid;
        gap: 12px;
      }

      .challenge-panel h2 {
        font-size: 0.95rem;
        margin: 0;
        color: var(--toolbar-text);
      }

      .challenge-panel button {
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        border: none;
        background: #0ea5e9;
        color: #f8fafc;
        font-weight: 700;
        cursor: pointer;
      }

      .challenge-modal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.65);
        display: grid;
        place-items: center;
        z-index: 30;
        padding: 24px;
      }

      .challenge-modal[hidden] {
        display: none;
      }

      .challenge-card {
        width: min(92vw, 520px);
        background: var(--panel-bg);
        border-radius: 20px;
        border: 1px solid var(--panel-border);
        box-shadow: 0 24px 50px rgba(15, 23, 42, 0.3);
        padding: 20px;
        display: grid;
        gap: 16px;
      }

      .challenge-card h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--toolbar-text);
      }

      .challenge-levels {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .challenge-levels button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(248, 250, 252, 0.9);
        color: #0f172a;
        font-weight: 700;
        cursor: pointer;
      }

      .challenge-question {
        display: grid;
        gap: 10px;
      }

      .challenge-question p {
        margin: 0;
        color: var(--toolbar-text);
        font-weight: 600;
      }

      .challenge-answers {
        display: grid;
        gap: 8px;
      }

      .challenge-answers button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(248, 250, 252, 0.9);
        color: #0f172a;
        font-weight: 700;
        cursor: pointer;
      }

      .challenge-footer {
        display: flex;
        justify-content: flex-end;
      }

      .challenge-footer button {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(248, 250, 252, 0.9);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }

      body[data-theme="dark"] .toolbar select,
      body[data-theme="night-runner"] .toolbar select,
      body[data-theme="phantom"] .toolbar select,
      body[data-theme="shadow"] .toolbar select,
      body[data-theme="nexus"] .toolbar select,
      body[data-theme="red-samurai"] .toolbar select,
      body[data-theme="drowning"] .toolbar select,
      body[data-theme="spiderman"] .toolbar select,
      body[data-theme="godspeed"] .toolbar select,
      body[data-theme="glitch"] .toolbar select,
      body[data-theme="antimatter"] .toolbar select,
      body[data-theme="war"] .toolbar select,
      body[data-theme="rainbow-trail"] .toolbar select {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(148, 163, 184, 0.4);
      }

      body[data-theme="dark"] .toolbar option,
      body[data-theme="night-runner"] .toolbar option,
      body[data-theme="phantom"] .toolbar option,
      body[data-theme="shadow"] .toolbar option,
      body[data-theme="nexus"] .toolbar option,
      body[data-theme="red-samurai"] .toolbar option,
      body[data-theme="drowning"] .toolbar option,
      body[data-theme="spiderman"] .toolbar option,
      body[data-theme="godspeed"] .toolbar option,
      body[data-theme="glitch"] .toolbar option,
      body[data-theme="antimatter"] .toolbar option,
      body[data-theme="war"] .toolbar option,
      body[data-theme="rainbow-trail"] .toolbar option {
        color: #e2e8f0;
        background: #0f172a;
      }

      .field-wrapper {
        display: flex;
        justify-content: center;
        position: relative;
      }

      .field-stage {
        position: relative;
      }

      .field {
        position: relative;
        --field-width: min(96vw, 1152px);
        --dot-size: 52px;
        width: var(--field-width);
        height: min(calc(var(--field-width) / 1.12), 820px);
        border-radius: 28px;
        border: 10px solid var(--field-border);
        background-color: var(--field-bg);

        /* Default grid */
        background-image:
          linear-gradient(
            90deg,
            rgba(107, 114, 128, 0.25) 0,
            rgba(107, 114, 128, 0.25) 1px,
            transparent 1px,
            transparent 72px
          ),
          linear-gradient(
            180deg,
            rgba(107, 114, 128, 0.25) 0,
            rgba(107, 114, 128, 0.25) 1px,
            transparent 1px,
            transparent 72px
          );
        background-size: 72px 72px;

        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
        overflow: hidden;
      }

      .field.canvas-bg {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      .field canvas,
      .connector-layer,
      .goal-point,
      .marker {
        position: absolute;
      }

      .connector-layer {
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .connector-layer line {
        stroke-width: 2.4;
        stroke-linecap: round;
        opacity: 0.75;
      }

      #drawingCanvas {
        inset: 0;
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }

      .marker {
        width: var(--dot-size);
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        transform: translate(-50%, -50%) rotate(var(--rotation, 0deg));
        box-shadow: 0 10px 18px rgba(15, 23, 42, 0.35);
        display: grid;
        place-items: center;
        color: #f8fafc;
        font-weight: 700;
        letter-spacing: 0.04em;
        user-select: none;
        transition: transform 0.2s ease;
      }

      .marker::after {
        content: attr(data-label);
      }

      .field.is-arrow-mode .marker {
        border-radius: 8px;
        clip-path: polygon(0 30%, 72% 30%, 72% 10%, 100% 50%, 72% 90%, 72% 70%, 0 70%);
        width: calc(var(--dot-size) * 1.35);
        height: calc(var(--dot-size) * 0.8);
      }

      .field.is-arrow-mode .marker::after {
        font-size: 0.7rem;
        transform: translateX(-6px);
      }

      .marker.red {
        background: radial-gradient(circle at 30% 30%, #ff9b9b, #b91c1c 65%);
      }

      .marker.blue {
        background: radial-gradient(circle at 30% 30%, #93c5fd, #1d4ed8 65%);
      }

      .marker.highlight {
        background: radial-gradient(circle at 30% 30%, #fef08a, #facc15 70%);
        color: #92400e;
      }

      .field.moving .marker:active {
        transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) scale(1.05);
      }

      .goal-point {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        opacity: 0.85;
        box-shadow: 0 0 12px rgba(15, 23, 42, 0.45);
        border: 2px solid var(--goal-outline);
      }

      .goal-point::before {
        content: "";
        position: absolute;
        inset: 4px;
        border-radius: 50%;
        background: #f8fafc;
        opacity: 0.85;
      }

      .goal-point::after {
        content: attr(data-label);
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translate(-50%, -100%);
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        background: var(--panel-bg);
        color: var(--toolbar-text);
        border: 1px solid var(--panel-border);
        text-transform: uppercase;
        white-space: nowrap;
      }

      .goal-point.red {
        background: #b91c1c;
      }

      .goal-point.blue {
        background: #1d4ed8;
      }

      .spawn-point {
        position: absolute;
        width: 14px;
        height: 14px;
        border-radius: 999px;
        transform: translate(-50%, -50%);
        pointer-events: none;
        opacity: 0.85;
        border: 2px dashed var(--goal-outline);
        background: rgba(255, 255, 255, 0.3);
        pointer-events: none;
        display: none;
      }

      .spawn-point::after {
        content: attr(data-label);
        position: absolute;
        top: -4px;
        left: 50%;
        transform: translate(-50%, -100%);
        font-size: 0.6rem;
        font-weight: 600;
        color: var(--toolbar-text);
        opacity: 0.7;
      }

      .spawn-point.red {
        border-color: rgba(239, 68, 68, 0.6);
      }

      .spawn-point.blue {
        border-color: rgba(59, 130, 246, 0.6);
      }

      .field.show-spawn .spawn-point {
        display: block;
      }

     

      

      .marker.is-hidden {
        display: none;
      }

      .hint {
        margin-left: auto;
        font-size: 0.85rem;
        color: var(--toolbar-text);
        font-weight: 600;
        opacity: 0.9;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--hint-bg);
        border: 1px solid rgba(203, 213, 225, 0.7);
      }

      .settings-panel {
        background: var(--panel-bg);
        border-radius: 18px;
        padding: 12px;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.2);
        backdrop-filter: blur(6px);
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-content: start;
        width: 280px;
        position: absolute;
        right: calc(100% + 16px);
        top: 0;
        height: 100%;
        bottom: 0;
        height: 100%;
        max-height: none;
        overflow: visible;
      }

      .settings-panel.is-popup {
        z-index: 10;
        border: 1px solid var(--panel-border);
      }

      .settings-panel.is-popup .settings-drawer {
        background: transparent;
      }

      .saved-panel {
        background: var(--panel-bg);
        border-radius: 18px;
        padding: 12px;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.2);
        backdrop-filter: blur(6px);
        display: grid;
        gap: 12px;
        width: 220px;
        position: absolute;
        left: calc(100% + 16px);
        top: 0;
      }

      .settings-toggle {
        width: 100%;
        padding: 4px 10px;
        height: 40px;
        border-radius: 999px;
        border: none;
        background: #2563eb;
        color: #f8fafc;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        align-self: start;
      }

      .settings-drawer {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        max-height: none;
        overflow: auto;
        padding-right: 4px;
        padding-bottom: 0;
      }

      .settings-drawer[hidden] {
        display: none;
      }

      .settings-drawer h2 {
        font-size: 0.95rem;
        margin: 0;
        color: var(--toolbar-text);
      }

      .settings-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
        min-height: 0;
        overflow: auto;
        overflow-x: hidden;
      }

      .settings-item {
        display: grid;
        gap: 8px;
        padding: 8px;
        border-radius: 14px;
        background: rgba(248, 250, 252, 0.9);
        border: 1px solid #e2e8f0;
        min-width: 0;
      }

      .settings-item label {
        font-size: 0.85rem;
        color: var(--toolbar-text);
        font-weight: 600;
        display: grid;
        gap: 6px;
      }

      .settings-item input[type="text"] {
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-weight: 600;
        width: 100%;
      }

      .settings-item input[type="color"] {
        width: 100%;
        height: 34px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        padding: 0;
        background: none;
        cursor: pointer;
      }

      .settings-item button,
      #restoreDots {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(248, 250, 252, 0.9);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }

      #restoreDots {
        margin-top: 0;
      }

      .settings-item button {
        justify-self: start;
      }

      .settings-panel::-webkit-scrollbar,
      .settings-drawer::-webkit-scrollbar,
      .settings-list::-webkit-scrollbar {
        width: 8px;
      }

      .settings-panel::-webkit-scrollbar-thumb,
      .settings-drawer::-webkit-scrollbar-thumb,
      .settings-list::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.6);
        border-radius: 999px;
      }

      .settings-drawer h2 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .theme-toggle {
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        border: none;
        background: #1d4ed8;
        color: #f8fafc;
        font-weight: 700;
        cursor: pointer;
      }

      .theme-panel {
        position: absolute;
        left: calc(100% + 14px);
        top: 0;
        width: 260px;
        padding: 12px;
        border-radius: 18px;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.2);
        backdrop-filter: blur(8px);
        z-index: 12;
      }

      .theme-panel[hidden] {
        display: none;
      }

      .theme-panel h3 {
        margin: 0 0 10px;
        font-size: 0.9rem;
        color: var(--toolbar-text);
      }

      .theme-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        max-height: 320px;
        overflow: auto;
        padding-right: 4px;
      }

      .theme-grid button {
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 12px;
        padding: 8px 10px;
        font-weight: 700;
        cursor: pointer;
        font-size: 0.8rem;
        text-align: center;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .theme-grid button.active {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(15, 23, 42, 0.25);
      }

      .theme-grid::-webkit-scrollbar {
        width: 6px;
      }

      .theme-grid::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.6);
        border-radius: 999px;
      }


      .saved-panel h2 {
        font-size: 0.95rem;
        margin: 0;
        color: var(--toolbar-text);
      }

      .saved-panel input[type="text"] {
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-weight: 600;
        width: 100%;
      }

      body[data-theme="dark"] .settings-item,
      body[data-theme="night-runner"] .settings-item,
      body[data-theme="phantom"] .settings-item,
      body[data-theme="shadow"] .settings-item,
      body[data-theme="nexus"] .settings-item,
      body[data-theme="red-samurai"] .settings-item,
      body[data-theme="drowning"] .settings-item,
      body[data-theme="spiderman"] .settings-item,
      body[data-theme="godspeed"] .settings-item,
      body[data-theme="glitch"] .settings-item,
      body[data-theme="antimatter"] .settings-item,
      body[data-theme="war"] .settings-item,
      body[data-theme="rainbow-trail"] .settings-item {
        background: rgba(30, 41, 59, 0.85);
        border-color: rgba(148, 163, 184, 0.25);
      }

      body[data-theme="dark"] .settings-item input[type="text"],
      body[data-theme="dark"] .saved-panel input[type="text"],
      body[data-theme="night-runner"] .settings-item input[type="text"],
      body[data-theme="night-runner"] .saved-panel input[type="text"],
      body[data-theme="phantom"] .settings-item input[type="text"],
      body[data-theme="phantom"] .saved-panel input[type="text"],
      body[data-theme="shadow"] .settings-item input[type="text"],
      body[data-theme="shadow"] .saved-panel input[type="text"],
      body[data-theme="nexus"] .settings-item input[type="text"],
      body[data-theme="nexus"] .saved-panel input[type="text"],
      body[data-theme="red-samurai"] .settings-item input[type="text"],
      body[data-theme="red-samurai"] .saved-panel input[type="text"],
      body[data-theme="drowning"] .settings-item input[type="text"],
      body[data-theme="drowning"] .saved-panel input[type="text"],
      body[data-theme="spiderman"] .settings-item input[type="text"],
      body[data-theme="spiderman"] .saved-panel input[type="text"],
      body[data-theme="godspeed"] .settings-item input[type="text"],
      body[data-theme="godspeed"] .saved-panel input[type="text"],
      body[data-theme="glitch"] .settings-item input[type="text"],
      body[data-theme="glitch"] .saved-panel input[type="text"],
      body[data-theme="antimatter"] .settings-item input[type="text"],
      body[data-theme="antimatter"] .saved-panel input[type="text"],
      body[data-theme="war"] .settings-item input[type="text"],
      body[data-theme="war"] .saved-panel input[type="text"],
      body[data-theme="rainbow-trail"] .settings-item input[type="text"],
      body[data-theme="rainbow-trail"] .saved-panel input[type="text"] {
        background: rgba(15, 23, 42, 0.6);
        border-color: rgba(148, 163, 184, 0.3);
        color: #e2e8f0;
      }

      .saved-panel button {
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        border: none;
        background: #0f172a;
        color: #f8fafc;
        font-weight: 700;
        cursor: pointer;
      }

      .saved-list {
        display: grid;
        gap: 10px;
      }

      .saved-list button {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(248, 250, 252, 0.9);
        color: #0f172a;
        font-weight: 600;
        padding: 8px 10px;
        cursor: pointer;
        text-align: left;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .splash {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: radial-gradient(circle at top left, #e2e8f0, #bfdbfe);
        z-index: 999;
        animation: splash-fade-out 0.8s ease 1.1s forwards;
      }

      .splash__logo {
        font-size: clamp(2.5rem, 8vw, 4.5rem);
        font-weight: 800;
        letter-spacing: 0.08em;
        color: #1e3a8a;
        text-transform: uppercase;
        animation: splash-fade-in 0.8s ease forwards;
      }

      @keyframes splash-fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes splash-fade-out {
        to {
          opacity: 0;
          visibility: hidden;
        }
      }

      @keyframes app-fade-in {
        to {
          opacity: 1;
        }
      }

      @media (max-width: 640px) {
        .toolbar {
          gap: 10px;
        }

        .toolbar h1 {
          flex-basis: 100%;
        }

        .hint {
          flex-basis: 100%;
          margin-left: 0;
        }

        .field-wrapper {
          justify-content: stretch;
        }

        .field-stage {
          display: grid;
          gap: 12px;
        }

        .settings-panel {
          position: static;
          width: 100%;
        }

        .saved-panel {
          position: static;
          width: 100%;
        }
      }
    </style>
  </head>
   <body class="is-loading">
    <div class="splash" id="splashScreen" aria-hidden="true">
      <div class="splash__logo">GrifMaps</div>
    </div>
    <main class="app" aria-labelledby="appTitle">
      <div class="toolbar" role="group" aria-label="Drawing controls">
        <h1 id="appTitle">Grifmaps</h1>

        <button type="button" data-mode="move" class="active">Move Pieces</button>
        <button type="button" data-mode="draw">Draw Routes</button>
        

        <label>
          <span class="sr-only">Brush color</span>
          <input type="color" id="colorPicker" value="#ef4444" aria-label="Brush color" />
        </label>

        <label for="brushSize">Brush size</label>
        <input type="range" id="brushSize" min="2" max="24" value="8" aria-label="Brush Size" />

        <label for="backgroundSelect">Background</label>
        <select id="backgroundSelect" aria-label="Background preset">
          <option value="grid" selected>Grid (Default)</option>
          <option value="football">Football Field</option>
          <option value="basketball">Basketball Court</option>
          <option value="chalk">Chalkboard</option>
          <option value="soccer">Soccer Pitch</option>
          <option value="ice">Ice Rink</option>
          <option value="infinite-sigma">Infinite Sigma</option>
        </select>

     
        
        
        <button type="button" id="quizModeToggle" aria-pressed="false">Quiz Mode</button>
        <button type="button" id="downloadPng">Download PNG</button>
        <button type="button" id="clearCanvas">Clear Drawing</button>

        <span class="hint">Tip: Right-click a marker to toggle its goal line.</span>
      </div>

      <div class="field-wrapper">
        <div class="field-stage">
          <aside class="settings-panel is-popup" aria-label="Marker settings">
            <button type="button" class="settings-toggle" id="settingsToggle" aria-expanded="true">
              Settings
            </button>
            <div class="settings-drawer" id="settingsDrawer">
              <h2>Dot controls</h2>
            <div class="settings-item">
              <label for="dotSize">Dot size</label>
              <input type="range" id="dotSize" min="28" max="90" value="52" />
            </div>
            <div class="settings-item">
              <label>
                <input type="checkbox" id="spawnToggle" />
                Show spawn points
              </label>
            </div>
            
              
            </div>
            <button type="button" class="theme-toggle" id="themeToggle">Themes</button>
            <div class="settings-list" id="settingsList"></div>
            <button type="button" id="restoreDots">Restore all dots</button>
          </div>
          <div class="theme-panel" id="themePanel" hidden>
            <h3>Select a theme</h3>
            <div class="theme-grid" id="themeGrid" role="list"></div>
          </div>
        </aside>
          <aside class="saved-panel" aria-label="Saved positions">
            <h2>Saved positions</h2>
            <label class="sr-only" for="saveName">Position name</label>
            <input type="text" id="saveName" placeholder="Position name" />
            <button type="button" id="savePosition">Save Position</button>
            <div class="saved-list" id="savedList" role="list"></div>
            <div class="challenge-panel" aria-label="Challenge mode" hidden> 
              <h2>Challenge mode</h2>
              <button type="button" id="challengeModeButton">Challenge mode</button>
            </div>
          </aside>
          <section class="field moving" id="field" aria-label="Interactive field">
            <canvas id="drawingCanvas" aria-hidden="true"></canvas>

            <svg class="connector-layer" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"></svg>

            
            <div class="goal-point red" data-label="Goal" data-goal="red" data-x="4" data-y="50" style="left: 4%; top: 50%;" aria-hidden="true"></div>
            <div class="goal-point blue" data-label="Goal" data-goal="blue" data-x="96" data-y="50" style="left: 96%; top: 50%;" aria-hidden="true"></div>
            <div class="spawn-point red" data-label="Spawn" data-x="4" data-y="26" style="left: 4%; top: 26%;" aria-hidden="true"></div>
            <div class="spawn-point red" data-label="Spawn" data-x="4" data-y="34" style="left: 4%; top: 34%;" aria-hidden="true"></div>
            <div class="spawn-point red" data-label="Spawn" data-x="4" data-y="66" style="left: 4%; top: 66%;" aria-hidden="true"></div>
            <div class="spawn-point red" data-label="Spawn" data-x="4" data-y="74" style="left: 4%; top: 74%;" aria-hidden="true"></div>

            <div class="spawn-point blue" data-label="Spawn" data-x="96" data-y="26" style="left: 96%; top: 26%;" aria-hidden="true"></div>
            <div class="spawn-point blue" data-label="Spawn" data-x="96" data-y="34" style="left: 96%; top: 34%;" aria-hidden="true"></div>
            <div class="spawn-point blue" data-label="Spawn" data-x="96" data-y="66" style="left: 96%; top: 66%;" aria-hidden="true"></div>
            <div class="spawn-point blue" data-label="Spawn" data-x="96" data-y="74" style="left: 96%; top: 74%;" aria-hidden="true"></div>
            

            <div class="marker red" data-label="R1" data-x="82" data-y="22" role="button"></div>
            <div class="marker red" data-label="R2" data-x="82" data-y="68" role="button"></div>
            <div class="marker red" data-label="R3" data-x="82" data-y="32" role="button"></div>
            <div class="marker red" data-label="R4" data-x="82" data-y="78" role="button"></div>

            <div class="marker blue" data-label="B1" data-x="18" data-y="26" role="button"></div>
            <div class="marker blue" data-label="B2" data-x="18" data-y="48" role="button"></div>
            <div class="marker blue" data-label="B3" data-x="18" data-y="60" role="button"></div>
            <div class="marker blue" data-label="B4" data-x="18" data-y="84" role="button"></div>

            
          </section>
        </div>
      </div>
    </main>
    <footer>
      <span>
        Grifmaps v1.2  Made by yLuxe
        
      </span>
    </footer>
    

    <div class="challenge-modal" id="challengeModal" hidden>
      <div class="challenge-card" role="dialog" aria-modal="true" aria-labelledby="challengeTitle">
        <div class="challenge-levels-view" id="challengeLevelsView">
          <h3 id="challengeTitle">Challenge Levels</h3>
          <div class="challenge-levels" id="challengeLevels"></div>
        </div>
        <div class="challenge-question" id="challengeQuestionView" hidden>
          <h3 id="challengeQuestionTitle">Level 1</h3>
          <p id="challengeQuestionText">Question goes here.</p>
          <div class="challenge-answers" id="challengeAnswers"></div>
        </div>
        <div class="challenge-footer">
          <button type="button" id="challengeClose">Close</button>
        </div>
      </div>
    </div>

    <script>
      const field = document.getElementById("field");
      const canvas = document.getElementById("drawingCanvas");
      const colorPicker = document.getElementById("colorPicker");
      const brushSizeControl = document.getElementById("brushSize");
      const clearButton = document.getElementById("clearCanvas");
      const dotSizeControl = document.getElementById("dotSize");
      const restoreDotsButton = document.getElementById("restoreDots");
      const spawnToggle = document.getElementById("spawnToggle");
      const arrowToggle = document.getElementById("arrowToggle");
      
      const themeToggle = document.getElementById("themeToggle");
      const themePanel = document.getElementById("themePanel");
      const themeGrid = document.getElementById("themeGrid");
      const challengeModeButton = document.getElementById("challengeModeButton");
      const challengeModal = document.getElementById("challengeModal");
      const challengeLevels = document.getElementById("challengeLevels");
      const challengeClose = document.getElementById("challengeClose");
      const challengeLevelsView = document.getElementById("challengeLevelsView");
      const challengeQuestionView = document.getElementById("challengeQuestionView");
      const challengeQuestionTitle = document.getElementById("challengeQuestionTitle");
      const challengeQuestionText = document.getElementById("challengeQuestionText");
      const challengeAnswers = document.getElementById("challengeAnswers");
      const quizModeToggle = document.getElementById("quizModeToggle");
      const downloadButton = document.getElementById("downloadPng");
      const modeButtons = document.querySelectorAll("[data-mode]");
      const backgroundSelect = document.getElementById("backgroundSelect");
      const commandBox = document.getElementById("commandBox");
      const commandLog = document.getElementById("commandLog");
      

      const markers = Array.from(document.querySelectorAll(".marker"));
      
      const connectorLayer = field.querySelector(".connector-layer");
      const markerConnections = new Map();
      const settingsToggle = document.getElementById("settingsToggle");
      const settingsDrawer = document.getElementById("settingsDrawer");
      const settingsList = document.getElementById("settingsList");
      const saveNameInput = document.getElementById("saveName");
      const savePositionButton = document.getElementById("savePosition");
      const savedList = document.getElementById("savedList");
      const ctx = canvas.getContext("2d");

      const goalTargets = {
        red: field.querySelector('[data-goal="red"]'),
        blue: field.querySelector('[data-goal="blue"]'),
      };

      let mode = "move";
      let activeMarker = null;
      
      
      let activePointerId = null;
      let pointerOffset = { x: 0, y: 0 };
      let isDrawing = false;
      let lastPoint = null;
      const savedPositions = [];
      const history = {
        past: [],
        future: [],
      };
      let dragStartState = null;
      let dragStartPosition = null;

      

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function resizeCanvas() {
        const rect = field.getBoundingClientRect();
        const prev = document.createElement("canvas");
        prev.width = canvas.width;
        prev.height = canvas.height;
        prev.getContext("2d").drawImage(canvas, 0, 0);

        canvas.width = Math.round(rect.width);
        canvas.height = Math.round(rect.height);

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(prev, 0, 0, prev.width, prev.height, 0, 0, canvas.width, canvas.height);
      }

      function pointerPercentages(event, rect) {
        return {
          x: ((event.clientX - rect.left) / rect.width) * 100,
          y: ((event.clientY - rect.top) / rect.height) * 100,
        };
      }

      function positionMarker(marker, xPercent, yPercent) {
        marker.style.left = `${xPercent}%`;
        marker.style.top = `${yPercent}%`;
        marker.dataset.x = xPercent.toFixed(2);
        marker.dataset.y = yPercent.toFixed(2);
        updateConnector(marker);
      }

      function refreshMarkerPositions() {
        markers.forEach((marker) => {
          const x = parseFloat(marker.dataset.x);
          const y = parseFloat(marker.dataset.y);
          positionMarker(marker, x, y);
        });
      }

      

      function getMarkerGoalKey(marker) {
        if (marker.classList.contains("red")) return "red";
        if (marker.classList.contains("blue")) return "blue";
        return null;
      }

      function createConnector(marker) {
        if (!connectorLayer || markerConnections.has(marker)) return;
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        const strokeColor = marker.dataset.color || (marker.classList.contains("red") ? "#ef4444" : "#3b82f6");
        line.setAttribute("stroke", strokeColor);
        connectorLayer.appendChild(line);
        markerConnections.set(marker, line);
        updateConnector(marker);
      }

      function removeConnector(marker) {
        const line = markerConnections.get(marker);
        if (!line) return;
        line.remove();
        markerConnections.delete(marker);
      }

      function updateConnector(marker) {
        if (!connectorLayer || !markerConnections.has(marker)) return;
        const line = markerConnections.get(marker);
        const goalKey = getMarkerGoalKey(marker);
        const goalPoint = goalKey ? goalTargets[goalKey] : null;
        if (!line || !goalPoint) return;

        const strokeColor = marker.dataset.color || (marker.classList.contains("red") ? "#ef4444" : "#3b82f6");
        line.setAttribute("stroke", strokeColor);

        const markerX = parseFloat(marker.dataset.x);
        const markerY = parseFloat(marker.dataset.y);
        const goalX = parseFloat(goalPoint.dataset.x);
        const goalY = parseFloat(goalPoint.dataset.y);

        line.setAttribute("x1", markerX);
        line.setAttribute("y1", markerY);
        line.setAttribute("x2", goalX);
        line.setAttribute("y2", goalY);
      }

      function refreshConnectorPositions() {
        markers.forEach(updateConnector);
      }

      function getMarkerState(marker) {
        return {
          x: parseFloat(marker.dataset.x),
          y: parseFloat(marker.dataset.y),
          hidden: marker.classList.contains("is-hidden"),
          label: marker.dataset.label || "",
          color: marker.dataset.color || "",
        };
      }

      function getCurrentState() {
        return {
          markers: markers.map((marker) => getMarkerState(marker)),
          
        };
      }

      function applyMarkerState(marker, state) {
        if (!state) return;
        positionMarker(marker, state.x, state.y);
        marker.classList.toggle("is-hidden", Boolean(state.hidden));
        marker.dataset.label = state.label || "";
        if (state.color) {
          applyMarkerColor(marker, state.color);
        } else {
          applyMarkerColor(marker, getDefaultMarkerColor(marker));
        }
        if (marker.classList.contains("is-hidden")) {
          removeConnector(marker);
        } else if (marker.classList.contains("highlight")) {
          createConnector(marker);
        }
      }

      function applyState(state) {
        if (!state) return;
        state.markers.forEach((markerState, index) => {
          const marker = markers[index];
          if (!marker) return;
          applyMarkerState(marker, markerState);
        });
        
        buildMarkerSettings();
        refreshConnectorPositions();
      }

      function pushHistory(snapshot) {
        history.past.push(snapshot);
        if (history.past.length > 100) {
          history.past.shift();
        }
        history.future = [];
      }

      function undo() {
        if (history.past.length === 0) return;
        const current = getCurrentState();
        const previous = history.past.pop();
        history.future.push(current);
        applyState(previous);
      }

      function redo() {
        if (history.future.length === 0) return;
        const current = getCurrentState();
        const next = history.future.pop();
        history.past.push(current);
        applyState(next);
      }

      function handleDotSizeChange(value) {
        const clamped = clamp(parseFloat(value), 28, 90);
        field.style.setProperty("--dot-size", `${clamped}px`);
      }

      function setTheme(theme) {
        document.body.dataset.theme = theme;
        if (themeGrid) {
          const buttons = themeGrid.querySelectorAll("button[data-theme]");
          buttons.forEach((button) => {
            button.classList.toggle("active", button.dataset.theme === theme);
          });
        }
        
      }

      function setQuizMode(isQuizMode) {
        if (!quizModeToggle) return;
        quizModeToggle.setAttribute("aria-pressed", String(isQuizMode));
        if (!isQuizMode) return;
        const snapshot = getCurrentState();
        let changed = false;
        markers.forEach((marker) => {
          if (!marker.classList.contains("is-hidden")) {
            marker.classList.add("is-hidden");
            removeConnector(marker);
            changed = true;
          }
        });
        if (changed) {
          pushHistory(snapshot);
        }
        buildMarkerSettings();
      }

      const challengeLevelsData = [
        {
          id: 1,
          title: "Level 1",
          markers: [
            { x: 82, y: 83, label: "Grif", highlight: true },
            { x: 62, y: 84, label: "R2" },
            { x: 70, y: 64, label: "R3" },
            { x: 24, y: 22, label: "R4" },
            { x: 18, y: 38, label: "B1" },
            { x: 64, y: 47, label: "B2" },
            { x: 54, y: 64, label: "B3" },
            { x: 42, y: 78, label: "B4" },
          ],
          question: "What should R4 be doing in this position?",
          answers: [
            { text: "A - Back up and stay alive", correct: false },
            { text: "B - Rush B1 and try to get the kill", correct: true },
            { text: "C - Run back to Kill B2 from behind.", correct: false },
            { text: "D - Pull a sword out and try to backstep B1.", correct: false },
          ],
        },
        ...Array.from({ length: 9 }, (_, index) => ({
          id: index + 2,
          title: `Level ${index + 2}`,
          markers: [
            { x: 78 - index, y: 20 + index * 2 },
            { x: 70 - index, y: 68 - index },
            { x: 58 - index, y: 35 + index },
            { x: 74 - index, y: 78 - index * 1.5 },
            { x: 18 + index, y: 25 + index },
            { x: 32 + index, y: 48 - index },
            { x: 46 + index, y: 60 - index * 1.2 },
            { x: 26 + index, y: 82 - index },
          ],
          question: "Placeholder question text.",
          answers: [
            { text: "Answer A", correct: false },
            { text: "Answer B", correct: true },
            { text: "Answer C", correct: false },
            { text: "Answer D", correct: false },
          ],
        })),
      ];

      function getDotSizePixels() {
        const size = parseFloat(getComputedStyle(field).getPropertyValue("--dot-size"));
        return Number.isNaN(size) ? 52 : size;
      }

      function drawGridBackground(ctx2d, width, height) {
        const styles = getComputedStyle(field);
        ctx2d.fillStyle = styles.backgroundColor || "#d4d4d8";
        ctx2d.fillRect(0, 0, width, height);

        ctx2d.strokeStyle = "rgba(107, 114, 128, 0.25)";
        ctx2d.lineWidth = 1;
        const spacing = 72;
        for (let x = 0; x <= width; x += spacing) {
          ctx2d.beginPath();
          ctx2d.moveTo(x, 0);
          ctx2d.lineTo(x, height);
          ctx2d.stroke();
        }
        for (let y = 0; y <= height; y += spacing) {
          ctx2d.beginPath();
          ctx2d.moveTo(0, y);
          ctx2d.lineTo(width, y);
          ctx2d.stroke();
        }
      }

      function drawSolidBackground(ctx2d, width, height) {
        const styles = getComputedStyle(field);
        const color = styles.backgroundColor || "#d4d4d8";
        ctx2d.fillStyle = color;
        ctx2d.fillRect(0, 0, width, height);
      }

      function getBackgroundImageUrl(backgroundValue) {
        if (!backgroundValue) return null;
        const match = backgroundValue.match(/^url\((['"]?)(.+?)\1\)$/);
        return match ? match[2] : null;
      }


      function loadImage(src) {
        return new Promise((resolve, reject) => {
          const image = new Image();
          image.crossOrigin = "anonymous";
          image.onload = () => resolve(image);
          image.onerror = reject;
          image.src = src;
        });
      }

      async function renderSnapshot() {
        const rect = field.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        const exportCanvas = document.createElement("canvas");
        exportCanvas.width = Math.round(rect.width * dpr);
        exportCanvas.height = Math.round(rect.height * dpr);
        const exportCtx = exportCanvas.getContext("2d");
        exportCtx.scale(dpr, dpr);

        if (backgroundSelect.value === "grid") {
          drawGridBackground(exportCtx, rect.width, rect.height);
        } else {
          const bg = bgPresets[backgroundSelect.value];
          const imageUrl = bg ? getBackgroundImageUrl(bg) : null;
          if (imageUrl) {
            try {
              const image = await loadImage(imageUrl);
              exportCtx.drawImage(image, 0, 0, rect.width, rect.height);
            } catch (error) {
              drawSolidBackground(exportCtx, rect.width, rect.height);
            }
          } else if (bg) {
            drawSolidBackground(exportCtx, rect.width, rect.height);
          } else {
            drawGridBackground(exportCtx, rect.width, rect.height);
          }
        }

        exportCtx.drawImage(canvas, 0, 0, rect.width, rect.height);

        markers.forEach((marker) => {
          if (marker.classList.contains("is-hidden")) return;
          if (!marker.classList.contains("highlight")) return;
          const goalKey = getMarkerGoalKey(marker);
          const goalPoint = goalKey ? goalTargets[goalKey] : null;
          if (!goalPoint) return;
          const markerX = (parseFloat(marker.dataset.x) / 100) * rect.width;
          const markerY = (parseFloat(marker.dataset.y) / 100) * rect.height;
          const goalX = (parseFloat(goalPoint.dataset.x) / 100) * rect.width;
          const goalY = (parseFloat(goalPoint.dataset.y) / 100) * rect.height;
          exportCtx.strokeStyle = marker.dataset.color || getDefaultMarkerColor(marker);
          exportCtx.lineWidth = 2.4;
          exportCtx.beginPath();
          exportCtx.moveTo(markerX, markerY);
          exportCtx.lineTo(goalX, goalY);
          exportCtx.stroke();
        });

        const dotSize = getDotSizePixels();
        markers.forEach((marker, index) => {
          if (marker.classList.contains("is-hidden")) return;
          const markerX = (parseFloat(marker.dataset.x) / 100) * rect.width;
          const markerY = (parseFloat(marker.dataset.y) / 100) * rect.height;
          const color = marker.dataset.color || getDefaultMarkerColor(marker);
          exportCtx.fillStyle = color;
          exportCtx.beginPath();
          exportCtx.arc(markerX, markerY, dotSize / 2, 0, Math.PI * 2);
          exportCtx.fill();

          const label = marker.dataset.label || `Dot ${index + 1}`;
          exportCtx.fillStyle = getReadableTextColor(color);
          exportCtx.font = `${Math.max(12, dotSize * 0.3)}px "Inter", system-ui, sans-serif`;
          exportCtx.textAlign = "center";
          exportCtx.textBaseline = "middle";
          exportCtx.fillText(label, markerX, markerY);
        });

        Object.values(goalTargets).forEach((goalPoint) => {
          const goalX = (parseFloat(goalPoint.dataset.x) / 100) * rect.width;
          const goalY = (parseFloat(goalPoint.dataset.y) / 100) * rect.height;
          const goalColor = goalPoint.classList.contains("red") ? "#ef4444" : "#3b82f6";
          exportCtx.fillStyle = goalColor;
          exportCtx.beginPath();
          exportCtx.arc(goalX, goalY, 9, 0, Math.PI * 2);
          exportCtx.fill();
          exportCtx.strokeStyle = getComputedStyle(goalPoint).borderColor || "rgba(15, 23, 42, 0.35)";
          exportCtx.lineWidth = 2;
          exportCtx.stroke();

          exportCtx.fillStyle = getComputedStyle(document.body).color || "#0f172a";
          exportCtx.font = "11px \"Inter\", system-ui, sans-serif";
          exportCtx.textAlign = "center";
          exportCtx.textBaseline = "bottom";
          exportCtx.fillText("GOAL", goalX, goalY - 12);
        });

        return exportCanvas;
      }

      function setMode(newMode) {
        mode = newMode;

        modeButtons.forEach((button) => {
          const isActive = button.dataset.mode === newMode;
          button.classList.toggle("active", isActive);
        });

        field.classList.toggle("drawing-mode", newMode === "draw");
        field.classList.toggle("rotate-mode", newMode === "rotate");
        
        field.classList.toggle("moving", newMode === "move");

        // Markers should not be draggable in draw mode
        markers.forEach((marker) => {
          marker.style.pointerEvents = newMode === "move" || newMode === "rotate" ? "auto" : "none";
        });

      

        
      }

      function onMarkerPointerDown(event) {
        // Right click toggles connector
        if (event.button === 2) {
          event.preventDefault();
          const marker = event.currentTarget;
          const shouldHighlight = !marker.classList.contains("highlight");
          marker.classList.toggle("highlight", shouldHighlight);
          if (shouldHighlight) createConnector(marker);
          else removeConnector(marker);
          updateConnector(marker);
          return;
        }

        if (mode === "rotate") {
          event.preventDefault();
          const marker = event.currentTarget;
          const current = parseFloat(marker.dataset.rotation || "0");
          const next = (current + 90) % 360;
          marker.dataset.rotation = String(next);
          marker.style.setProperty("--rotation", `${next}deg`);
          return;
        }

        if (mode !== "move") return;

        event.preventDefault();
        activeMarker = event.currentTarget;
        activePointerId = event.pointerId;

        const rect = field.getBoundingClientRect();
        const pointerPercents = pointerPercentages(event, rect);
        const markerX = parseFloat(activeMarker.dataset.x);
        const markerY = parseFloat(activeMarker.dataset.y);

        pointerOffset = {
          x: pointerPercents.x - markerX,
          y: pointerPercents.y - markerY,
        };

        dragStartState = getCurrentState();
        dragStartPosition = { x: markerX, y: markerY };

        activeMarker.setPointerCapture(activePointerId);
      }

      function onMarkerPointerMove(event) {
        if (!activeMarker || event.pointerId !== activePointerId) return;

        const rect = field.getBoundingClientRect();
        const { x, y } = pointerPercentages(event, rect);
        const markerWidthPercent = ((activeMarker.offsetWidth / 2) / rect.width) * 100;
        const markerHeightPercent = ((activeMarker.offsetHeight / 2) / rect.height) * 100;

        const targetX = clamp(x - pointerOffset.x, markerWidthPercent, 100 - markerWidthPercent);
        const targetY = clamp(y - pointerOffset.y, markerHeightPercent, 100 - markerHeightPercent);

        positionMarker(activeMarker, targetX, targetY);
      }

      function endMarkerDrag(event) {
        if (event.pointerId !== activePointerId) return;
        activeMarker?.releasePointerCapture(activePointerId);
        if (activeMarker && dragStartState && dragStartPosition) {
          const currentX = parseFloat(activeMarker.dataset.x);
          const currentY = parseFloat(activeMarker.dataset.y);
          if (currentX !== dragStartPosition.x || currentY !== dragStartPosition.y) {
            pushHistory(dragStartState);
          }
        }
        activeMarker = null;
        activePointerId = null;
        dragStartState = null;
        dragStartPosition = null;
      }

     

      function startDrawing(event) {
        if (mode !== "draw") return;
        event.preventDefault();
        isDrawing = true;
        lastPoint = getCanvasCoordinates(event);
      }

      function draw(event) {
        if (!isDrawing) return;
        const point = getCanvasCoordinates(event);

        ctx.strokeStyle = colorPicker.value;
        ctx.lineWidth = parseFloat(brushSizeControl.value);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        ctx.beginPath();
        ctx.moveTo(lastPoint.x, lastPoint.y);
        ctx.lineTo(point.x, point.y);
        ctx.stroke();

        lastPoint = point;
      }

      function stopDrawing() {
        isDrawing = false;
      }

      function getCanvasCoordinates(event) {
        const rect = field.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (event.clientX - rect.left) * scaleX,
          y: (event.clientY - rect.top) * scaleY,
        };
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      function clampChannel(value) {
        return clamp(Math.round(value), 0, 255);
      }

      function hexToRgb(hex) {
        const normalized = hex.replace("#", "");
        const value = normalized.length === 3
          ? normalized.split("").map((ch) => ch + ch).join("")
          : normalized;
        const int = parseInt(value, 16);
        return {
          r: (int >> 16) & 255,
          g: (int >> 8) & 255,
          b: int & 255,
        };
      }

      function rgbToHex({ r, g, b }) {
        return `#${[r, g, b].map((channel) => channel.toString(16).padStart(2, "0")).join("")}`;
      }

      function adjustColor(hex, amount) {
        const { r, g, b } = hexToRgb(hex);
        return rgbToHex({
          r: clampChannel(r + amount),
          g: clampChannel(g + amount),
          b: clampChannel(b + amount),
        });
      }

      function getReadableTextColor(hex) {
        const { r, g, b } = hexToRgb(hex);
        const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
        return luminance > 0.6 ? "#0f172a" : "#f8fafc";
      }

      function applyMarkerColor(marker, color, applyStyle = true) {
        marker.dataset.color = color;
        if (applyStyle) {
          const highlight = adjustColor(color, 50);
          const shade = adjustColor(color, -40);
          marker.style.background = `radial-gradient(circle at 30% 30%, ${highlight}, ${shade} 65%)`;
          marker.style.color = getReadableTextColor(color);
        }
        updateConnector(marker);
      }

      function getDefaultMarkerColor(marker) {
        return marker.classList.contains("red") ? "#ef4444" : "#3b82f6";
      }

      function buildMarkerSettings() {
        if (!settingsList) return;
        settingsList.innerHTML = "";

        markers.forEach((marker, index) => {
          const wrapper = document.createElement("div");
          wrapper.className = "settings-item";

          const nameLabel = document.createElement("label");
          nameLabel.textContent = `Dot label (${marker.dataset.label || `Dot ${index + 1}`})`;
          const nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.value = marker.dataset.label || "";
          nameInput.setAttribute("aria-label", `Label for ${marker.dataset.label || `dot ${index + 1}`}`);

          nameInput.addEventListener("input", () => {
            marker.dataset.label = nameInput.value;
          });

          nameLabel.appendChild(nameInput);

          const colorLabel = document.createElement("label");
          colorLabel.textContent = "Dot color";
          const colorInput = document.createElement("input");
          colorInput.type = "color";
          colorInput.value = marker.dataset.color || getDefaultMarkerColor(marker);
          colorInput.setAttribute("aria-label", `Color for ${marker.dataset.label || `dot ${index + 1}`}`);

          colorInput.addEventListener("input", () => {
            applyMarkerColor(marker, colorInput.value);
          });

          colorLabel.appendChild(colorInput);

          const toggleButton = document.createElement("button");
          toggleButton.type = "button";
          toggleButton.textContent = marker.classList.contains("is-hidden") ? "Restore dot" : "Delete dot";
          toggleButton.addEventListener("click", () => {
            const snapshot = getCurrentState();
            marker.classList.toggle("is-hidden");
            if (marker.classList.contains("is-hidden")) {
              removeConnector(marker);
            } else if (marker.classList.contains("highlight")) {
              createConnector(marker);
            }
            toggleButton.textContent = marker.classList.contains("is-hidden") ? "Restore dot" : "Delete dot";
            pushHistory(snapshot);
          });

          wrapper.appendChild(nameLabel);
          wrapper.appendChild(colorLabel);
          wrapper.appendChild(toggleButton);
          settingsList.appendChild(wrapper);
        });
      }

      function promptMarkerLabel(marker) {
        const currentLabel = marker.dataset.label || "";
        const nextLabel = window.prompt("Enter dot label:", currentLabel);
        if (nextLabel === null) return;
        marker.dataset.label = nextLabel.trim();
        buildMarkerSettings();
      }

      function initializeMarkerColors() {
        markers.forEach((marker) => {
          applyMarkerColor(marker, marker.dataset.color || getDefaultMarkerColor(marker), false);
        });
      }

      function applyTeamColor(teamClass, color) {
        const teamMarkers = markers.filter((marker) => marker.classList.contains(teamClass));
        teamMarkers.forEach((marker) => {
          applyMarkerColor(marker, color);
        });
      }

      function collectMarkerPositions() {
        return markers.map((marker) => ({
          x: parseFloat(marker.dataset.x),
          y: parseFloat(marker.dataset.y),
        }));
      }

      function applyMarkerPositions(positionSet) {
        positionSet.forEach((position, index) => {
          const marker = markers[index];
          if (!marker || !position) return;
          positionMarker(marker, position.x, position.y);
        });
      }

      function renderSavedPositions() {
        if (!savedList) return;
        savedList.innerHTML = "";

        savedPositions.forEach((position, index) => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = position.name;
          button.addEventListener("click", () => {
            applyMarkerPositions(position.markers);
          });
          button.setAttribute("role", "listitem");
          button.dataset.index = String(index);
          savedList.appendChild(button);
        });
      }

      function saveCurrentPosition() {
        const fallbackName = `Position ${savedPositions.length + 1}`;
        const name = saveNameInput?.value.trim() || fallbackName;
        savedPositions.push({
          name,
          markers: collectMarkerPositions(),
        });
        if (saveNameInput) saveNameInput.value = "";
        renderSavedPositions();
      }


      // ---- Background presets (inline SVG data URLs) ----
      const bgPresets = {
        grid: null,
        "infinite-sigma": 'url("InfiniteSigma.png")',
        football: svgDataUrl(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#166534"/>
                <stop offset="1" stop-color="#14532d"/>
              </linearGradient>
              <pattern id="stripes" width="160" height="160" patternUnits="userSpaceOnUse">
                <rect width="160" height="160" fill="none"/>
                <rect x="0" y="0" width="80" height="160" fill="rgba(255,255,255,0.06)"/>
              </pattern>
            </defs>
            <rect width="1200" height="800" fill="url(#g)"/>
            <rect width="1200" height="800" fill="url(#stripes)"/>
            <g stroke="rgba(255,255,255,0.72)" stroke-width="4">
              <rect x="60" y="60" width="1080" height="680" fill="none" rx="24"/>
              <line x1="600" y1="60" x2="600" y2="740"/>
            </g>
            <g stroke="rgba(255,255,255,0.45)" stroke-width="2">
              ${Array.from({length: 20}, (_, i) => {
                const x = 60 + i * (1080/20);
                return `<line x1="${x}" y1="60" x2="${x}" y2="740"/>`;
              }).join("")}
            </g>
            <g fill="rgba(255,255,255,0.75)" font-family="system-ui, sans-serif" font-size="26" font-weight="700">
              <text x="90" y="110">10</text><text x="90" y="700">10</text>
              <text x="1090" y="110" text-anchor="end">10</text><text x="1090" y="700" text-anchor="end">10</text>
            </g>
          </svg>
        `),
        basketball: svgDataUrl(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800">
            <defs>
              <linearGradient id="wood" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#f3e1c5"/>
                <stop offset="1" stop-color="#e6c89d"/>
              </linearGradient>
              <pattern id="planks" width="120" height="120" patternUnits="userSpaceOnUse">
                <rect width="120" height="120" fill="none"/>
                <path d="M0 0 H120" stroke="rgba(124,45,18,0.15)" stroke-width="6"/>
              </pattern>
            </defs>
            <rect width="1200" height="800" fill="url(#wood)"/>
            <rect width="1200" height="800" fill="url(#planks)" opacity="0.8"/>
            <g stroke="rgba(15,23,42,0.65)" stroke-width="6" fill="none">
              <rect x="80" y="80" width="1040" height="640" rx="26"/>
              <line x1="600" y1="80" x2="600" y2="720"/>
              <circle cx="600" cy="400" r="90"/>
              <rect x="80" y="250" width="190" height="300" rx="18"/>
              <rect x="930" y="250" width="190" height="300" rx="18"/>
              <circle cx="270" cy="400" r="70"/>
              <circle cx="930" cy="400" r="70"/>
            </g>
          </svg>
        `),
        chalk: svgDataUrl(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800">
            <defs>
              <filter id="noise">
                <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/>
                <feColorMatrix type="matrix"
                  values="1 0 0 0 0
                          0 1 0 0 0
                          0 0 1 0 0
                          0 0 0 0.18 0"/>
              </filter>
            </defs>
            <rect width="1200" height="800" fill="#0b2b26"/>
            <rect width="1200" height="800" filter="url(#noise)"/>
            <g stroke="rgba(248,250,252,0.6)" stroke-width="5" fill="none">
              <rect x="80" y="80" width="1040" height="640" rx="28"/>
              <path d="M120 200 C 300 120, 420 260, 600 200 S 900 300, 1080 220" />
              <path d="M120 520 C 320 600, 460 460, 600 520 S 900 420, 1080 520" />
              <circle cx="600" cy="400" r="90"/>
            </g>
          </svg>
        `),
        soccer: svgDataUrl(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800">
            <defs>
              <linearGradient id="grass" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#15803d"/>
                <stop offset="1" stop-color="#166534"/>
              </linearGradient>
            </defs>
            <rect width="1200" height="800" fill="url(#grass)"/>
            <g stroke="rgba(255,255,255,0.75)" stroke-width="4" fill="none">
              <rect x="60" y="60" width="1080" height="680" rx="24"/>
              <line x1="600" y1="60" x2="600" y2="740"/>
              <circle cx="600" cy="400" r="90"/>
              <rect x="60" y="240" width="180" height="320" rx="18"/>
              <rect x="960" y="240" width="180" height="320" rx="18"/>
              <rect x="60" y="310" width="60" height="180" rx="12"/>
              <rect x="1080" y="310" width="60" height="180" rx="12"/>
              <circle cx="120" cy="400" r="8"/>
              <circle cx="1080" cy="400" r="8"/>
            </g>
          </svg>
        `),
        ice: svgDataUrl(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800">
            <defs>
              <linearGradient id="ice" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#e2f0ff"/>
                <stop offset="1" stop-color="#c7ddf5"/>
              </linearGradient>
            </defs>
            <rect width="1200" height="800" fill="url(#ice)"/>
            <g stroke="rgba(30,64,175,0.7)" stroke-width="5" fill="none">
              <rect x="80" y="80" width="1040" height="640" rx="120"/>
              <line x1="600" y1="80" x2="600" y2="720"/>
              <circle cx="600" cy="400" r="110"/>
            </g>
            <g stroke="rgba(239,68,68,0.7)" stroke-width="4" fill="none">
              <line x1="80" y1="220" x2="1120" y2="220"/>
              <line x1="80" y1="580" x2="1120" y2="580"/>
              <circle cx="260" cy="400" r="70"/>
              <circle cx="940" cy="400" r="70"/>
            </g>
          </svg>
        `),
      };

      function svgDataUrl(svgString) {
        const cleaned = svgString.replace(/\s+/g, " ").trim();
        return `url("data:image/svg+xml;utf8,${encodeURIComponent(cleaned)}")`;
      }

      function applyBackgroundPreset(key) {
        if (key === "grid") {
          field.classList.remove("canvas-bg");
          field.style.backgroundColor = "var(--field-bg)";
          field.style.backgroundImage =
            "linear-gradient(90deg, rgba(107, 114, 128, 0.25) 0, rgba(107, 114, 128, 0.25) 1px, transparent 1px, transparent 72px), " +
            "linear-gradient(180deg, rgba(107, 114, 128, 0.25) 0, rgba(107, 114, 128, 0.25) 1px, transparent 1px, transparent 72px)";
          field.style.backgroundSize = "72px 72px";
          field.style.backgroundPosition = "center";
          field.style.backgroundRepeat = "repeat";
          return;
        }

        field.classList.add("canvas-bg");
        field.style.backgroundSize = "cover";
        field.style.backgroundPosition = "center";
        field.style.backgroundRepeat = "no-repeat";
        field.style.backgroundImage = bgPresets[key] || "none";
      }

     

      // ---- Event listeners ----
      field.addEventListener("contextmenu", (e) => e.preventDefault());

      markers.forEach((marker) => {
        marker.addEventListener("contextmenu", (e) => e.preventDefault());
        marker.addEventListener("pointerdown", onMarkerPointerDown);
        marker.addEventListener("pointermove", onMarkerPointerMove);
        marker.addEventListener("pointerup", endMarkerDrag);
        marker.addEventListener("pointercancel", endMarkerDrag);
        marker.addEventListener("dblclick", () => {
          promptMarkerLabel(marker);
        });
      });

      

      field.addEventListener("pointerdown", (event) => {
        if (mode === "draw") startDrawing(event);
      
      });

      field.addEventListener("pointermove", draw);
      window.addEventListener("pointerup", stopDrawing);
      window.addEventListener("pointercancel", stopDrawing);

      modeButtons.forEach((button) => {
        button.addEventListener("click", () => setMode(button.dataset.mode));
      });

      backgroundSelect.addEventListener("change", () => {
        applyBackgroundPreset(backgroundSelect.value);
      });

      clearButton.addEventListener("click", clearCanvas);

      

      if (settingsToggle && settingsDrawer) {
        settingsToggle.addEventListener("click", () => {
          const isExpanded = settingsToggle.getAttribute("aria-expanded") === "true";
          settingsToggle.setAttribute("aria-expanded", String(!isExpanded));
          settingsDrawer.hidden = isExpanded;
          if (themePanel && !settingsDrawer.hidden) return;
          if (themePanel) themePanel.setAttribute("hidden", "");
        });
      }

      if (dotSizeControl) {
        dotSizeControl.addEventListener("input", () => {
          handleDotSizeChange(dotSizeControl.value);
        });
      }

      if (spawnToggle) {
        spawnToggle.addEventListener("change", () => {
          field.classList.toggle("show-spawn", spawnToggle.checked);
        });
      }

      if (arrowToggle) {
        arrowToggle.addEventListener("change", () => {
          field.classList.toggle("is-arrow-mode", arrowToggle.checked);
        });
      }

      

      if (quizModeToggle) {
        quizModeToggle.addEventListener("click", () => {
          setQuizMode(true);
        });
      }

      if (downloadButton) {
        downloadButton.addEventListener("click", async () => {
          const snapshot = await renderSnapshot();
          const link = document.createElement("a");
          link.download = `grifmaps-${Date.now()}.png`;
          link.href = snapshot.toDataURL("image/png");
          link.click();
        });
      }

      if (restoreDotsButton) {
        restoreDotsButton.addEventListener("click", () => {
          const snapshot = getCurrentState();
          let changed = false;
          markers.forEach((marker) => {
            if (marker.classList.contains("is-hidden")) {
              marker.classList.remove("is-hidden");
              changed = true;
              if (marker.classList.contains("highlight")) {
                createConnector(marker);
              }
            }
          });
          if (changed) {
            pushHistory(snapshot);
          }
          buildMarkerSettings();
        });
      }

      if (savePositionButton) {
        savePositionButton.addEventListener("click", saveCurrentPosition);
      }

      const teamColorMap = {
        red: "#ef4444",
        blue: "#3b82f6",
        orange: "#f97316",
        green: "#22c55e",
        purple: "#8b5cf6",
        yellow: "#facc15",
        white: "#f8fafc",
        black: "#0f172a",
      };

      function writeCommandLog(message) {
        if (!commandLog) return;
        commandLog.textContent = message;
      }

      

      if (commandBox) {
        commandBox.addEventListener("keydown", (event) => {
          if (event.key !== "Enter") return;
          const rawValue = commandBox.value.trim();
          if (!rawValue.startsWith("/")) return;
          const value = rawValue.toLowerCase();
          const [command, param] = value.split(/\s+/);
          const color = teamColorMap[param];
          const labelMatch = rawValue.match(/"([^"]+)"|'([^']+)'/);
          const label = labelMatch ? (labelMatch[1] || labelMatch[2]) : null;
          const setPosMatch = rawValue.match(/\/setpos\s*\[\s*([^,\]]+)\s*,\s*([0-9.]+)\s*,\s*([0-9.]+)\s*\]/i);
          const getPosMatch = rawValue.match(/\/getpos\s+([^\s]+)/i);

          function getMarkerByLabel(labelText) {
            if (!labelText) return null;
            const normalized = labelText.trim().toLowerCase();
            return markers.find((marker) => {
              const markerLabel = (marker.dataset.label || marker.getAttribute("data-label") || "").toLowerCase();
              return markerLabel === normalized;
            });
          }

          function setMarkerVisibility(marker, isVisible) {
            if (!marker) return;
            marker.classList.toggle("is-hidden", !isVisible);
            if (!isVisible) {
              removeConnector(marker);
            } else if (marker.classList.contains("highlight")) {
              createConnector(marker);
            }
          }

          function setTeamVisibility(teamClass, isVisible) {
            markers.filter((marker) => marker.classList.contains(teamClass))
              .forEach((marker) => setMarkerVisibility(marker, isVisible));
          }

          function help() {
            writeCommandLog("Commands: /team1, /team2, /getPos, /setPos, /hide, /show, /hideTeam, /showTeam, restoreAllDots(), /scatter, /clear, /help");
          }

          if (command === "/team1" && color) {
            applyTeamColor("red", color);
            writeCommandLog(`Team 1 set to ${param}.`);
          } else if (command === "/team2" && color) {
            applyTeamColor("blue", color);
            writeCommandLog(`Team 2 set to ${param}.`);
          } else if (command === "/getpos" && getPosMatch) {
            const marker = getMarkerByLabel(getPosMatch[1]);
            if (marker) {
              writeCommandLog(`${getPosMatch[1]}: {x: ${marker.dataset.x}, y: ${marker.dataset.y}}`);
            }
          } else if (setPosMatch) {
            const marker = getMarkerByLabel(setPosMatch[1]);
            if (marker) {
              positionMarker(marker, parseFloat(setPosMatch[2]), parseFloat(setPosMatch[3]));
              writeCommandLog(`${setPosMatch[1]} moved.`);
            }
          } else if (command.startsWith("/hide")) {
            const marker = getMarkerByLabel(label);
            setMarkerVisibility(marker, false);
            writeCommandLog(`${label || "Marker"} hidden.`);
          } else if (command.startsWith("/show")) {
            const marker = getMarkerByLabel(label);
            setMarkerVisibility(marker, true);
            writeCommandLog(`${label || "Marker"} shown.`);
          } else if (command.startsWith("/hideteam")) {
            const team = label?.toLowerCase();
            if (team === "team1") setTeamVisibility("red", false);
            if (team === "team2") setTeamVisibility("blue", false);
            writeCommandLog(`${label || "Team"} hidden.`);
          } else if (command.startsWith("/showteam")) {
            const team = label?.toLowerCase();
            if (team === "team1") setTeamVisibility("red", true);
            if (team === "team2") setTeamVisibility("blue", true);
            writeCommandLog(`${label || "Team"} shown.`);
          } else if (command === "/scatter") {
            const snapshot = getCurrentState();
            markers.forEach((marker) => {
              const x = 10 + Math.random() * 80;
              const y = 10 + Math.random() * 80;
              positionMarker(marker, x, y);
            });
            pushHistory(snapshot);
            writeCommandLog("Markers scattered.");
          } else if (command === "/clear") {
            clearCanvas();
            writeCommandLog("Canvas cleared.");
          } else if (command === "/help") {
            help();
          } else if (rawValue === "restoreAllDots()") {
            restoreDotsButton?.click();
            writeCommandLog("Dots restored.");
          } else {
            writeCommandLog("Unknown command. Type /help.");
          }
          commandBox.value = "";
        });
      }

      

      function showChallengeModal() {
        if (!challengeModal) return;
        challengeModal.removeAttribute("hidden");
        if (challengeLevelsView) challengeLevelsView.hidden = false;
        if (challengeQuestionView) challengeQuestionView.hidden = true;
      }

      function hideChallengeModal() {
        if (!challengeModal) return;
        challengeModal.setAttribute("hidden", "");
      }

      function renderChallengeLevels() {
        if (!challengeLevels) return;
        challengeLevels.innerHTML = "";
        challengeLevelsData.forEach((level) => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = level.title;
          button.addEventListener("click", () => {
            applyChallengeMarkers(level.markers);
            showChallengeQuestion(level);
          });
          challengeLevels.appendChild(button);
        });
      }

      function applyChallengeMarkers(levelMarkers) {
        if (!Array.isArray(levelMarkers)) return;
        const snapshot = getCurrentState();
        levelMarkers.forEach((markerData, index) => {
          const marker = markers[index];
          if (!marker) return;
          if (typeof markerData === "object" && markerData !== null) {
            const x = Number(markerData.x ?? marker.dataset.x);
            const y = Number(markerData.y ?? marker.dataset.y);
            positionMarker(marker, x, y);
            if (markerData.label) {
              marker.dataset.label = markerData.label;
            }
            const shouldHighlight = Boolean(markerData.highlight);
            marker.classList.toggle("highlight", shouldHighlight);
            if (shouldHighlight) createConnector(marker);
            else removeConnector(marker);
          }
        });
        pushHistory(snapshot);
        buildMarkerSettings();
        refreshConnectorPositions();
      }

      function showChallengeQuestion(level) {
        if (!challengeQuestionTitle || !challengeQuestionText || !challengeAnswers) return;
        challengeQuestionTitle.textContent = level.title;
        challengeQuestionText.textContent = level.question;
        challengeAnswers.innerHTML = "";
        level.answers.forEach((answer) => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = answer.text;
          button.addEventListener("click", () => {
            if (answer.correct) {
              if (challengeQuestionView) challengeQuestionView.hidden = true;
              if (challengeLevelsView) challengeLevelsView.hidden = false;
            } else {
              button.style.opacity = "0.6";
            }
          });
          challengeAnswers.appendChild(button);
        });
        if (challengeLevelsView) challengeLevelsView.hidden = true;
        if (challengeQuestionView) challengeQuestionView.hidden = false;
      }

      if (challengeModeButton) {
        challengeModeButton.addEventListener("click", showChallengeModal);
      }

      if (challengeClose) {
        challengeClose.addEventListener("click", hideChallengeModal);
      }

      if (challengeModal) {
        challengeModal.addEventListener("click", (event) => {
          if (event.target === challengeModal) hideChallengeModal();
        });
      }

      window.addEventListener("keydown", (event) => {
        const target = event.target;
        const isFormField = target instanceof HTMLElement
          && (target.tagName === "INPUT" || target.tagName === "TEXTAREA" || target.tagName === "SELECT" || target.isContentEditable);
        if (isFormField) return;
        if (!(event.ctrlKey || event.metaKey) || event.altKey) return;

        const key = event.key.toLowerCase();
        if (key === "z") {
          event.preventDefault();
          if (event.shiftKey) redo();
          else undo();
        } else if (key === "y") {
          event.preventDefault();
          redo();
        }
      });

      window.addEventListener("keydown", (event) => {
        const target = event.target;
        const isFormField = target instanceof HTMLElement
          && (target.tagName === "INPUT" || target.tagName === "TEXTAREA" || target.tagName === "SELECT" || target.isContentEditable);
        if (isFormField || event.ctrlKey || event.metaKey || event.altKey) return;
        const key = event.key.toLowerCase();
        if (key === "d") {
          setMode("draw");
        } else if (key === "m") {
          setMode("move");
        } else if (key === "r") {
          setMode("rotate");
        }
      });

      window.addEventListener("resize", () => {
        resizeCanvas();
        refreshMarkerPositions();
        
        refreshConnectorPositions();

        
      });

      // init
      resizeCanvas();
      initializeMarkerColors();
      if (dotSizeControl) {
        handleDotSizeChange(dotSizeControl.value);
      }
      if (window.matchMedia) {
        setTheme(window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      } else {
        setTheme("light");
      }
      buildMarkerSettings();
      refreshMarkerPositions();
      
      refreshConnectorPositions();
      applyBackgroundPreset(backgroundSelect.value);

      const themeOptions = [
        { value: "light", label: "Light", swatch: "#e2e8f0", text: "#0f172a" },
        
        { value: "bingsu", label: "Bingsu", swatch: "#e2e8f0", text: "#334155" },
        { value: "macroblank", label: "Macroblank", swatch: "#cbd5f5", text: "#1e293b" },
        { value: "fruit-chew", label: "Fruit Chew", swatch: "#e2e8f0", text: "#4c1d95" },
        { value: "peaches", label: "Peaches", swatch: "#fed7aa", text: "#9a3412" },
        { value: "hanok", label: "Hanok", swatch: "#e7e5e4", text: "#3f2f24" },
        { value: "retro", label: "Retro", swatch: "#fde68a", text: "#92400e" },
        { value: "pastel", label: "Pastel", swatch: "#e0f2fe", text: "#6b21a8" },
        { value: "frozen-llama", label: "Frozen Llama", swatch: "#a7f3d0", text: "#0f766e" },
        { value: "mizu", label: "Mizu", swatch: "#bae6fd", text: "#1e3a8a" },
        { value: "tiramisu", label: "Tiramisu", swatch: "#fef3c7", text: "#78350f" },
        { value: "bubblegum", label: "Bubblegum", swatch: "#fbcfe8", text: "#831843" },
        { value: "cheesecake", label: "Cheesecake", swatch: "#fbcfe8", text: "#9d174d" },
        { value: "strawberry", label: "Strawberry", swatch: "#fda4af", text: "#9f1239" },
        { value: "pink-lemonade", label: "Pink Lemonade", swatch: "#fde68a", text: "#9f1239" },
        { value: "lavender", label: "Lavender", swatch: "#ddd6fe", text: "#4c1d95" },
        { value: "grape", label: "Grape", swatch: "#c4b5fd", text: "#4c1d95" },
        { value: "snes", label: "SNES", swatch: "#c4b5fd", text: "#312e81" },
        { value: "vaporwave", label: "Vaporwave", swatch: "#f0abfc", text: "#312e81" },
        { value: "fleuriste", label: "Fleuriste", swatch: "#fbcfe8", text: "#9d174d" },
        { value: "iceberg", label: "Iceberg", swatch: "#bae6fd", text: "#1e3a8a" },
        { value: "retrocast", label: "Retrocast", swatch: "#facc15", text: "#0f172a" },
        { value: "honey", label: "Honey", swatch: "#f59e0b", text: "#7c2d12" },
        { value: "mexican", label: "Mexican", swatch: "#f97316", text: "#7c2d12" },
        { value: "creamsicle", label: "Creamsicle", swatch: "#fed7aa", text: "#7c2d12" },
        { value: "menthol", label: "Menthol", swatch: "#86efac", text: "#14532d" },
        { value: "trance", label: "Trance", swatch: "#a855f7", text: "#0f172a" },
        { value: "earthsong", label: "Earthsong", swatch: "#1C4D28", text: "#657A61" },
        { value: "nexus", label: "Nexus", swatch: "#22d3ee", text: "#0f172a" },
        { value: "drowning", label: "Drowning", swatch: "#0f3d5c", text: "#e0f2fe" },
        { value: "night-runner", label: "Night Runner", swatch: "#0ea5e9", text: "#e0f2fe" },
        { value: "shadow", label: "Shadow", swatch: "#111827", text: "#e5e7eb" },
        { value: "phantom", label: "Phantom", swatch: "#0f766e", text: "#e2e8f0" },
        { value: "glitch", label: "Glitch", swatch: "#312e81", text: "#fdf2f8" },
        { value: "antimatter", label: "Antimatter", swatch: "#4c1d95", text: "#e0e7ff" },
        { value: "godspeed", label: "Godspeed", swatch: "#111827", text: "#fef3c7" },
        { value: "red-samurai", label: "Red Samurai", swatch: "#7f1d1d", text: "#fee2e2" },
        { value: "spiderman", label: "Spiderman", swatch: "#7f1d1d", text: "#fee2e2" },
        { value: "war", label: "War", swatch: "#7f1d1d", text: "#fee2e2" },
        { value: "rainbow-trail", label: "Rainbow Trail", swatch: "#0f172a", text: "#f8fafc" },
        { value: "dark", label: "Dark", swatch: "#0f172a", text: "#e2e8f0" },
        { value: "iv-clover", label: "IV Clover", swatch: "#64748b", text: "#1e293b" },
        
      ];

      function renderThemeGrid() {
        if (!themeGrid) return;
        themeGrid.innerHTML = "";
        themeOptions.forEach((option) => {
          const button = document.createElement("button");
          button.type = "button";
          button.dataset.theme = option.value;
          button.textContent = option.label;
          button.style.background = option.swatch;
          button.style.color = option.text;
          button.addEventListener("click", () => {
            setTheme(option.value);
          });
          themeGrid.appendChild(button);
        });
        setTheme(document.body.dataset.theme || "light");
      }

      if (themeToggle && themePanel) {
        themeToggle.addEventListener("click", () => {
          const isHidden = themePanel.hasAttribute("hidden");
          if (isHidden) themePanel.removeAttribute("hidden");
          else themePanel.setAttribute("hidden", "");
        });
      }

      renderThemeGrid();
      renderChallengeLevels();

      const splashScreen = document.getElementById("splashScreen");
      if (splashScreen) {
        const splashLogo = splashScreen.querySelector(".splash__logo");
        const fonts = [
          '"Bebas Neue", system-ui, sans-serif',
          '"Oswald", system-ui, sans-serif',
          '"Space Grotesk", system-ui, sans-serif',
          '"Playfair Display", serif',
          '"Futura", system-ui, sans-serif',
          '"Segoe UI", system-ui, sans-serif',
          '"Trebuchet MS", system-ui, sans-serif',
          '"Courier New", monospace',
          '"Georgia", serif',
          '"Inter", system-ui, sans-serif',
        ];
        let logoInterval = null;

        if (splashLogo) {
          let idx = 0;
          logoInterval = setInterval(() => {
            splashLogo.style.fontFamily = fonts[idx % fonts.length];
            idx += 1;
          }, 90);
        }
        splashScreen.addEventListener("animationend", (event) => {
          if (event.animationName !== "splash-fade-out") return;
          if (logoInterval) {
            clearInterval(logoInterval);
            logoInterval = null;
          }
          splashScreen.remove();
          document.body.classList.remove("is-loading");
          
        });
      }
    </script>
  </body>
</html>
<!-- Navicon Theme Swapper, playback, spawn points, backround of court, Learn Stage -->